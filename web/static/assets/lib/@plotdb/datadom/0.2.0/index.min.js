(function(){var e,t,n,r,i,o,u,a;"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&(e=require("@plotdb/json0")),t=function(e,t){var n,r,i,o;for(null==e&&(e=[]),null==t&&(t=""),t=(n=(t=t.split("@"))[0]?[t[0],t[1]]:["@"+t[1],t[2]])[0],n[1],r=0,i=e.length;r<i;++r)if(o=r,t===e[o].name)return e[o];return null},n=function(e,t){if(Array.isArray(e.attr)&&e.attr.filter(function(e){return e&&e[0]}).map(function(e){return t.setAttribute(e[0],e[1])}),Array.isArray(e.style)&&e.style.filter(function(e){return e&&e[0]}).map(function(e){return t.style[e[0]]=e[1]}),Array.isArray(e.cls))return t.classList.add.apply(t.classList,e.cls.filter(function(e){return e}))},r=function(e,n,r){var i;return null==r&&(r=window),n=Array.isArray(n)?n:n?[n]:[],i=[],Promise.resolve().then(function(){var r;return(r=function(e){var o,u,a,s,l,d,c,p,h,f,m;switch(o=e.nodeName.toLowerCase()){case"#text":return{type:"text",value:e.nodeValue};case"#comment":return{type:"comment",value:e.nodeValue};case"#document-fragment":for(u={type:"document-fragment",child:[]},a=0,s=e.childNodes.length;a<s;++a)l=a,(d=r(e.childNodes[l]))&&u.child.push(d);return u;default:if(c=e.style?function(){var t,n,r=[];for(t=0,n=e.style.length;t<n;++t)l=t,r.push(l);return r}().map(function(t){return[e.style[t],e.style[e.style[t]]]}):[],p=e.attributes?function(){var t,n,r,i=[];for(t=0,r=(n=e.attributes).length;t<r;++t)h=n[t],i.push([h.nodeName,h.nodeValue]);return i}().filter(function(e){var t;return!(/^dd-/.exec(e[0])||"style"===(t=e[0])||"class"===t)}):[],f=e.classList?function(){var t,n,r,i=[];for(t=0,r=(n=e.classList).length;t<r;++t)h=n[t],i.push(h);return i}():[],u={style:c,attr:p,cls:f,child:[],plug:[]},!e.hasAttribute("dd-plugin")){for(a=0,s=e.childNodes.length;a<s;++a)l=a,(d=r(e.childNodes[l]))&&u.child.push(d);return u.type="tag",u.name=o,u}return u.type="custom",(m=t(n,e.getAttribute("dd-plugin")))?(u.plugin=m.name+"@"+m.version,(d=m.serialize({data:u,node:e,window:window,plugins:n}))instanceof Promise&&i.push(d),u):(u.plugin="unknown",u)}})(e)}).then(function(e){return{data:e,promise:Promise.all(i)}})},i=function(e,r,i){var o,u;return null==i&&(i=window),r=Array.isArray(r)?r:r?[r]:[],o=i.document,u=[],Promise.resolve().then(function(){var a;return(a=function(e){var s,l,d,c,p,h,f,m,y,g,v;switch(e.type){case"text":return o.createTextNode(e.value);case"comment":return o.createComment(e.value);case"document-fragment":for(s=o.createDocumentFragment(),l=0,c=(d=e.child||[]).length;l<c;++l)p=d[l],(h=a(p))&&s.appendChild(h);return s;case"tag":for(s=o.createElement(e.name),n(e,s),l=0,c=(d=e.child||[]).length;l<c;++l)p=d[l],(h=a(p))&&s.appendChild(h);return s;default:for(d=[o.createElement("div"),null],s=d[0],f=d[1],l=0,c=(d=e.child||[]).length;l<c;++l)p=d[l],(h=a(p))&&s.appendChild(h);for(y=[],l=0,c=(d=e.plug||[]).length;l<c;++l)p=d[l],y.push(a(p));return m=y,(g=t(r,e.plugin))?((h=g.deserialize({data:e,node:s,plugs:m,window:i,plugins:r}))?h instanceof Promise?(s.appendChild(v=o.createTextNode("(.. loading ..)")),f=h.then(function(t){return v.parentNode&&v.parentNode.removeChild(v),s!==t&&s.replaceWith(t),t.setAttribute("dd-plugin",g.name+"@"+g.version),n(e,t),t})):h instanceof i.Element?s=h:(s=h.node,f=h.promise):s.appendChild(o.createTextNode("(unknown)")),f&&u.push(f),s.setAttribute("dd-plugin",g.name+"@"+g.version),n(e,s),s):(s.appendChild(o.createTextNode("(unknown)")),s)}})(e)}).then(function(e){return{node:e,promise:Promise.all(u)}})},o=function(e,n,r){var i;return null==r&&(r=window),n=Array.isArray(n)?n:n?[n]:[],i=[],Promise.resolve().then(function(){var r;return(r=function(o){var u,a,s,l,d;if(o.hasAttribute("dd-plugin")){if(l=t(n,e.getAttribute("dd-plugin")))return(d=l.possess({node:e,plugins:n,window:window}))instanceof Promise?i.push(d):void 0}else for(u=0,a=o.childNodes.length;u<a;++u)s=u,r(o.childNodes[s])})(e)}).then(function(){return Promise.all(i)})},u=function(e,t,n){var r,o,u,a,s,l,d;for(r=n,o=t,u=e.p.length-1;u>=0&&(a=u,"attr"!==(s=e.p[a])&&"style"!==s&&"cls"!==s&&"child"!==s&&"name"!==s&&"value"!==s&&"type"!==s);--u);for(u=0,l=a-1;u<l;++u)u,d=e.p[a],r="child"===d?r.childNodes:r,o=o[d];switch(e.p[a]){case"name":case"value":case"type":return i(o).then(function(e){var t;return t=e.node,e.promise,r.parentNode.insertBefore(t,r),r.parentNode.removeChild(r)});case"style":return r.setAttribute("style",""),o.style.map(function(e){return r.style[e[0]]=e[1]});case"cls":return r.setAttribute("class",o.cls.join(" "));case"attr":return Array.from(r.attributes).map(function(e){var t;if(!o.attr[e.name]&&"custom"!==(t=e.name)&&"style"!==t&&"class"!==t)return r.removeAttribute(e.name)}),o.attr.map(function(e){return r.setAttribute(e[0],e[1])});case"child":if(e.ld&&r.removeChild(r.childNodes[e.p[a+1]]),e.li)return i(e.li).then(function(t){var n;return n=t.node,t.promise,r.insertBefore(n,r.childNodes[e.p[a+1]])})}},(a=function(e){var t;return null==e&&(e={}),this.opt=e,this.window=(t=e.window)?t:"undefined"!=typeof window&&null!==window?window:null,this.plugins=Array.isArray(e.plugins)?e.plugins:e.plugins?[e.plugins]:[],e.data?this.data=e.data:e.node&&(this.node=e.node),this}).prototype=function(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}(Object.create(Object.prototype),{init:function(){var e=this;return this.data?i(this.data,this.plugins,this.window).then(function(t){var n,r;return n=t.node,r=t.promise,e.node=n,{node:n,promise:r}}):(this.node||(this.node=document.createElement("div")),r(this.node,this.plugins,this.window).then(function(e){var t,n;return t=e.data,n=e.promise,this.data=t,{data:t,promise:n}}))},getData:function(){return this.data},getNode:function(){return this.node},update:function(t){var n,r,i,o=[];for(null==t&&(t=[]),n=0,r=t.length;n<r;++n)i=t[n],e.type.apply(this.data,[i]),o.push(u(i,this.data,this.node));return o}}),a.serialize=r,a.deserialize=i,a.possess=o,"undefined"!=typeof module&&null!==module?module.exports=a:"undefined"!=typeof window&&null!==window&&(window.datadom=a)}).call(this);
