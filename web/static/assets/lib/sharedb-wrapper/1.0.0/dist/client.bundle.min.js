require=function(require){var exposedRequire=function exposedRequire(e,r){return exposedRequire.m.hasOwnProperty(e)?exposedRequire.m[e]:"function"!=typeof require||r?"function"==typeof exposedRequire.r?exposedRequire.r(e,1):void 0:require(e,1)};exposedRequire.m={};exposedRequire.r=require;var _$events_1={};var objectCreate=Object.create||objectCreatePolyfill,objectKeys=Object.keys||objectKeysPolyfill,bind=Function.prototype.bind||functionBindPolyfill;function EventEmitter(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=objectCreate(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}_$events_1=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0;var hasDefineProperty,defaultMaxListeners=10;try{var o={};Object.defineProperty&&Object.defineProperty(o,"x",{value:0}),hasDefineProperty=0===o.x}catch(e){hasDefineProperty=!1}function $getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function emitNone(e,t,n){if(t)e.call(n);else for(var r=e.length,i=arrayClone(e,r),s=0;s<r;++s)i[s].call(n)}function emitOne(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,s=arrayClone(e,i),o=0;o<i;++o)s[o].call(n,r)}function emitTwo(e,t,n,r,i){if(t)e.call(n,r,i);else for(var s=e.length,o=arrayClone(e,s),a=0;a<s;++a)o[a].call(n,r,i)}function emitThree(e,t,n,r,i,s){if(t)e.call(n,r,i,s);else for(var o=e.length,a=arrayClone(e,o),l=0;l<o;++l)a[l].call(n,r,i,s)}function emitMany(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,s=arrayClone(e,i),o=0;o<i;++o)s[o].apply(n,r)}function _addListener(e,t,n,r){var i,s,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]):(s=e._events=objectCreate(null),e._eventsCount=0),o){if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=$getMaxListeners(e))&&i>0&&o.length>i){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",a.name,a.message)}}else o=s[t]=n,++e._eventsCount;return e}function onceWrapper(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function _onceWrap(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=bind.call(onceWrapper,r);return i.listener=n,r.wrapFn=i,i}function _listeners(e,t,n){var r=e._events;if(!r)return[];var i=r[t];return i?"function"==typeof i?n?[i.listener||i]:[i]:n?unwrapListeners(i):arrayClone(i,i.length):[]}function listenerCount(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function spliceOne(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}function arrayClone(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function unwrapListeners(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function objectCreatePolyfill(e){var t=function(){};return t.prototype=e,new t}function objectKeysPolyfill(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return n}function functionBindPolyfill(e){var t=this;return function(){return t.apply(e,arguments)}}hasDefineProperty?Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');defaultMaxListeners=e}}):EventEmitter.defaultMaxListeners=defaultMaxListeners,EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(e){var t,n,r,i,s,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var l=new Error('Unhandled "error" event. ('+t+")");throw l.context=t,l}if(!(n=o[e]))return!1;var u="function"==typeof n;switch(r=arguments.length){case 1:emitNone(n,u,this);break;case 2:emitOne(n,u,this,arguments[1]);break;case 3:emitTwo(n,u,this,arguments[1],arguments[2]);break;case 4:emitThree(n,u,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),s=1;s<r;s++)i[s-1]=arguments[s];emitMany(n,u,this,i)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var n,r,i,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=objectCreate(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():spliceOne(n,i),1===n.length&&(r[e]=n[0]),r.removeListener&&this.emit("removeListener",e,o||t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,n,r;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=objectCreate(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=objectCreate(null):delete n[e]),this;if(0===arguments.length){var i,s=objectKeys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=objectCreate(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},EventEmitter.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var _$emitter_13={};var __EventEmitter_13=_$events_1.EventEmitter;function mixin(t){for(var e in __EventEmitter_13.prototype)t.prototype[e]=__EventEmitter_13.prototype[e]}_$emitter_13.EventEmitter=__EventEmitter_13,_$emitter_13.mixin=mixin;var _$logger_16={};var SUPPORTED_METHODS=["info","warn","error"];function Logger(){var o={};SUPPORTED_METHODS.forEach(function(n){o[n]=console[n].bind(console)}),this.setMethods(o)}_$logger_16=Logger,Logger.prototype.setMethods=function(o){o=o||{};var n=this;SUPPORTED_METHODS.forEach(function(t){"function"==typeof o[t]&&(n[t]=o[t])})};var logger=new _$logger_16;var _$logger_15=logger;var _$error_14={};function ShareDBError(_,E){this.code=_,this.message=E||"",Error.captureStackTrace?Error.captureStackTrace(this,ShareDBError):this.stack=(new Error).stack}ShareDBError.prototype=Object.create(Error.prototype),ShareDBError.prototype.constructor=ShareDBError,ShareDBError.prototype.name="ShareDBError",ShareDBError.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"},_$error_14=ShareDBError;function bootstrapTransform(r,t,n,e){var l=r.transformX=function(r,o){n(r),n(o);for(var f,a,h,g=[],i=0;i<o.length;i++){for(var u=o[i],s=[],v=0;v<r.length;){var m=[];if(f=r[v],h=m,t(s,f,a=u,"left"),t(h,a,f,"right"),v++,1!==m.length){if(0===m.length){for(var b=v;b<r.length;b++)e(s,r[b]);u=null;break}for(var c=l(r.slice(v),m),p=0;p<c[0].length;p++)e(s,c[0][p]);for(var k=0;k<c[1].length;k++)e(g,c[1][k]);u=null;break}u=m[0]}null!=u&&e(g,u),r=s}return[r,g]};r.transform=function(r,n,e){if("left"!==e&&"right"!==e)throw new Error("type must be 'left' or 'right'");return 0===n.length?r:1===r.length&&1===n.length?t([],r[0],n[0],e):"left"===e?l(r,n)[0]:l(n,r)[1]}}var _$bootstrapTransform_2=bootstrapTransform;var _$text0_5={};var text=_$text0_5={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(e){if(null!=e&&"string"!=typeof e)throw new Error("Initial data must be a string");return e||""}},strInject=function(e,n,t){return e.slice(0,n)+t+e.slice(n)},checkValidComponent=function(e){if("number"!=typeof e.p)throw new Error("component missing position field");if("string"==typeof e.i==("string"==typeof e.d))throw new Error("component needs an i or d field");if(e.p<0)throw new Error("position cannot be negative")},checkValidOp=function(e){for(var n=0;n<e.length;n++)checkValidComponent(e[n])};text.apply=function(e,n){var t;checkValidOp(n);for(var p=0;p<n.length;p++){var r=n[p];if(null!=r.i)e=strInject(e,r.p,r.i);else{if(t=e.slice(r.p,r.p+r.d.length),r.d!==t)throw new Error("Delete component '"+r.d+"' does not match deleted text '"+t+"'");e=e.slice(0,r.p)+e.slice(r.p+r.d.length)}}return e};var append=text._append=function(e,n){if(""!==n.i&&""!==n.d)if(0===e.length)e.push(n);else{var t=e[e.length-1];null!=t.i&&null!=n.i&&t.p<=n.p&&n.p<=t.p+t.i.length?e[e.length-1]={i:strInject(t.i,n.p-t.p,n.i),p:t.p}:null!=t.d&&null!=n.d&&n.p<=t.p&&t.p<=n.p+n.d.length?e[e.length-1]={d:strInject(n.d,t.p-n.p,t.d),p:n.p}:e.push(n)}};text.compose=function(e,n){checkValidOp(e),checkValidOp(n);for(var t=e.slice(),p=0;p<n.length;p++)append(t,n[p]);return t},text.normalize=function(e){var n=[];null==e.i&&null==e.p||(e=[e]);for(var t=0;t<e.length;t++){var p=e[t];null==p.p&&(p.p=0),append(n,p)}return n};var transformPosition=function(e,n,t){return null!=n.i?n.p<e||n.p===e&&t?e+n.i.length:e:e<=n.p?e:e<=n.p+n.d.length?n.p:e-n.d.length};text.transformCursor=function(e,n,t){for(var p="right"===t,r=0;r<n.length;r++)e=transformPosition(e,n[r],p);return e};var transformComponent=text._tc=function(e,n,t,p){if(checkValidComponent(n),checkValidComponent(t),null!=n.i)append(e,{i:n.i,p:transformPosition(n.p,t,"right"===p)});else if(null!=t.i){var r=n.d;n.p<t.p&&(append(e,{d:r.slice(0,t.p-n.p),p:n.p}),r=r.slice(t.p-n.p)),""!==r&&append(e,{d:r,p:n.p+t.i.length})}else if(n.p>=t.p+t.d.length)append(e,{d:n.d,p:n.p-t.d.length});else if(n.p+n.d.length<=t.p)append(e,n);else{var i={d:"",p:n.p};n.p<t.p&&(i.d=n.d.slice(0,t.p-n.p)),n.p+n.d.length>t.p+t.d.length&&(i.d+=n.d.slice(t.p+t.d.length-n.p));var o=Math.max(n.p,t.p),l=Math.min(n.p+n.d.length,t.p+t.d.length);if(n.d.slice(o-n.p,l-n.p)!==t.d.slice(o-t.p,l-t.p))throw new Error("Delete ops delete different text in the same region of the document");""!==i.d&&(i.p=transformPosition(i.p,t),append(e,i))}return e},invertComponent=function(e){return null!=e.i?{d:e.i,p:e.p}:{i:e.d,p:e.p}};text.invert=function(e){e=e.slice().reverse();for(var n=0;n<e.length;n++)e[n]=invertComponent(e[n]);return e},_$bootstrapTransform_2(text,transformComponent,checkValidOp,append);var _$json0_4={};var isArray=function(o){return"[object Array]"==Object.prototype.toString.call(o)},isObject=function(o){return!!o&&o.constructor===Object},clone=function(o){return JSON.parse(JSON.stringify(o))},json={name:"json0",uri:"http://sharejs.org/types/JSONv0"},subtypes={};function convertFromText(o){o.t="text0";var n={p:o.p.pop()};null!=o.si&&(n.i=o.si),null!=o.sd&&(n.d=o.sd),o.o=[n]}function convertToText(o){o.p.push(o.o[0].p),null!=o.o[0].i&&(o.si=o.o[0].i),null!=o.o[0].d&&(o.sd=o.o[0].d),delete o.t,delete o.o}json.registerSubtype=function(o){subtypes[o.name]=o},json.create=function(o){return void 0===o?null:clone(o)},json.invertComponent=function(o){var n={p:o.p};return o.t&&subtypes[o.t]&&(n.t=o.t,n.o=subtypes[o.t].invert(o.o)),void 0!==o.si&&(n.sd=o.si),void 0!==o.sd&&(n.si=o.sd),void 0!==o.oi&&(n.od=o.oi),void 0!==o.od&&(n.oi=o.od),void 0!==o.li&&(n.ld=o.li),void 0!==o.ld&&(n.li=o.ld),void 0!==o.na&&(n.na=-o.na),void 0!==o.lm&&(n.lm=o.p[o.p.length-1],n.p=o.p.slice(0,o.p.length-1).concat([o.lm])),n},json.invert=function(o){for(var n=o.slice().reverse(),e=[],i=0;i<n.length;i++)e.push(json.invertComponent(n[i]));return e},json.checkValidOp=function(o){for(var n=0;n<o.length;n++)if(!isArray(o[n].p))throw new Error("Missing path")},json.checkList=function(o){if(!isArray(o))throw new Error("Referenced element not a list")},json.checkObj=function(o){if(!isObject(o))throw new Error("Referenced element not an object (it was "+JSON.stringify(o)+")")},json.apply=function(o,n){json.checkValidOp(n),n=clone(n);for(var e={data:o},i=0;i<n.length;i++){var l=n[i];null==l.si&&null==l.sd||convertFromText(l);for(var t=null,r=e,s="data",p=0;p<l.p.length;p++){var d=l.p[p];if(t=r,s,r=r[s],s=d,null==t)throw new Error("Path invalid")}if(l.t&&void 0!==l.o&&subtypes[l.t])r[s]=subtypes[l.t].apply(r[s],l.o);else if(void 0!==l.na){if("number"!=typeof r[s])throw new Error("Referenced element not a number");r[s]+=l.na}else if(void 0!==l.li&&void 0!==l.ld)json.checkList(r),r[s]=l.li;else if(void 0!==l.li)json.checkList(r),r.splice(s,0,l.li);else if(void 0!==l.ld)json.checkList(r),r.splice(s,1);else if(void 0!==l.lm){if(json.checkList(r),l.lm!=s){var u=r[s];r.splice(s,1),r.splice(l.lm,0,u)}}else if(void 0!==l.oi)json.checkObj(r),r[s]=l.oi;else{if(void 0===l.od)throw new Error("invalid / missing instruction in op");json.checkObj(r),delete r[s]}}return e.data},json.shatter=function(o){for(var n=[],e=0;e<o.length;e++)n.push([o[e]]);return n},json.incrementalApply=function(o,n,e){for(var i=0;i<n.length;i++){var l=[n[i]];e(l,o=json.apply(o,l))}return o};var pathMatches=json.pathMatches=function(o,n,e){if(o.length!=n.length)return!1;for(var i=0;i<o.length;i++)if(o[i]!==n[i]&&(!e||i!==o.length-1))return!1;return!0};json.append=function(o,n){if(n=clone(n),0!==o.length){var e=o[o.length-1];if(null==n.si&&null==n.sd||null==e.si&&null==e.sd||(convertFromText(n),convertFromText(e)),pathMatches(n.p,e.p))if(n.t&&e.t&&n.t===e.t&&subtypes[n.t]){if(e.o=subtypes[n.t].compose(e.o,n.o),null!=n.si||null!=n.sd){for(var i=n.p,l=0;l<e.o.length-1;l++)n.o=[e.o.pop()],n.p=i.slice(),convertToText(n),o.push(n);convertToText(e)}}else null!=e.na&&null!=n.na?o[o.length-1]={p:e.p,na:e.na+n.na}:void 0!==e.li&&void 0===n.li&&n.ld===e.li?void 0!==e.ld?delete e.li:o.pop():void 0!==e.od&&void 0===e.oi&&void 0!==n.oi&&void 0===n.od?e.oi=n.oi:void 0!==e.oi&&void 0!==n.od?void 0!==n.oi?e.oi=n.oi:void 0!==e.od?delete e.oi:o.pop():void 0!==n.lm&&n.p[n.p.length-1]===n.lm||o.push(n);else null==n.si&&null==n.sd||null==e.si&&null==e.sd||(convertToText(n),convertToText(e)),o.push(n)}else o.push(n)},json.compose=function(o,n){json.checkValidOp(o),json.checkValidOp(n);for(var e=clone(o),i=0;i<n.length;i++)json.append(e,n[i]);return e},json.normalize=function(o){var n=[];o=isArray(o)?o:[o];for(var e=0;e<o.length;e++){var i=o[e];null==i.p&&(i.p=[]),json.append(n,i)}return n},json.commonLengthForOps=function(o,n){var e=o.p.length,i=n.p.length;if((null!=o.na||o.t)&&e++,(null!=n.na||n.t)&&i++,0===e)return-1;if(0===i)return null;e--,i--;for(var l=0;l<e;l++){var t=o.p[l];if(l>=i||t!==n.p[l])return null}return e},json.canOpAffectPath=function(o,n){return null!=json.commonLengthForOps({p:n},o)},json.transformComponent=function(o,n,e,i){n=clone(n);var l=json.commonLengthForOps(e,n),t=json.commonLengthForOps(n,e),r=n.p.length,s=e.p.length;if((null!=n.na||n.t)&&r++,(null!=e.na||e.t)&&s++,null!=t&&s>r&&n.p[t]==e.p[t])if(void 0!==n.ld)(d=clone(e)).p=d.p.slice(r),n.ld=json.apply(clone(n.ld),[d]);else if(void 0!==n.od){(d=clone(e)).p=d.p.slice(r),n.od=json.apply(clone(n.od),[d])}if(null!=l){var p=r==s,d=e;if(null==n.si&&null==n.sd||null==e.si&&null==e.sd||(convertFromText(n),convertFromText(d=clone(e))),d.t&&subtypes[d.t]){if(n.t&&n.t===d.t){var u=subtypes[n.t].transform(n.o,d.o,i);if(null!=n.si||null!=n.sd)for(var c=n.p,f=0;f<u.length;f++)n.o=[u[f]],n.p=c.slice(),convertToText(n),json.append(o,n);else(!isArray(u)||u.length>0)&&(n.o=u,json.append(o,n));return o}}else if(void 0!==e.na);else if(void 0!==e.li&&void 0!==e.ld){if(e.p[l]===n.p[l]){if(!p)return o;if(void 0!==n.ld){if(void 0===n.li||"left"!==i)return o;n.ld=clone(e.li)}}}else if(void 0!==e.li)void 0!==n.li&&void 0===n.ld&&p&&n.p[l]===e.p[l]?"right"===i&&n.p[l]++:e.p[l]<=n.p[l]&&n.p[l]++,void 0!==n.lm&&p&&e.p[l]<=n.lm&&n.lm++;else if(void 0!==e.ld){if(void 0!==n.lm&&p){if(e.p[l]===n.p[l])return o;c=e.p[l];var a=n.p[l];(c<(v=n.lm)||c===v&&a<v)&&n.lm--}if(e.p[l]<n.p[l])n.p[l]--;else if(e.p[l]===n.p[l]){if(s<r)return o;if(void 0!==n.ld){if(void 0===n.li)return o;delete n.ld}}}else if(void 0!==e.lm)if(void 0!==n.lm&&r===s){a=n.p[l];var v=n.lm,h=e.p[l],m=e.lm;if(h!==m)if(a===h){if("left"!==i)return o;n.p[l]=m,a===v&&(n.lm=m)}else a>h&&n.p[l]--,a>m?n.p[l]++:a===m&&h>m&&(n.p[l]++,a===v&&n.lm++),v>h?n.lm--:v===h&&v>a&&n.lm--,v>m?n.lm++:v===m&&(m>h&&v>a||m<h&&v<a?"right"===i&&n.lm++:v>a?n.lm++:v===h&&n.lm--)}else if(void 0!==n.li&&void 0===n.ld&&p){a=e.p[l],v=e.lm;(c=n.p[l])>a&&n.p[l]--,c>v&&n.p[l]++}else{a=e.p[l],v=e.lm;(c=n.p[l])===a?n.p[l]=v:(c>a&&n.p[l]--,c>v?n.p[l]++:c===v&&a>v&&n.p[l]++)}else if(void 0!==e.oi&&void 0!==e.od){if(n.p[l]===e.p[l]){if(void 0===n.oi||!p)return o;if("right"===i)return o;n.od=e.oi}}else if(void 0!==e.oi){if(void 0!==n.oi&&n.p[l]===e.p[l]){if("left"!==i)return o;json.append(o,{p:n.p,od:e.oi})}}else if(void 0!==e.od&&n.p[l]==e.p[l]){if(!p)return o;if(void 0===n.oi)return o;delete n.od}}return json.append(o,n),o},_$bootstrapTransform_2(json,json.transformComponent,json.checkValidOp,json.append);json.registerSubtype(_$text0_5),_$json0_4=json;var _$lib_3={type:_$json0_4};var _$types_18={};_$types_18.defaultType=_$lib_3.type,_$types_18.map={},_$types_18.register=function(e){e.name&&(_$types_18.map[e.name]=e),e.uri&&(_$types_18.map[e.uri]=e)},_$types_18.register(_$types_18.defaultType);var _$browser_6={};var cachedSetTimeout,cachedClearTimeout,process=_$browser_6={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};var _$doc_8={};(function(process){var ERROR_CODE=_$error_14.CODES;function Doc(t,i,e){_$emitter_13.EventEmitter.call(this),this.connection=t,this.collection=i,this.id=e,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function pushActionCallback(t,i,e){if(i){var n=t.pop();t.push(function(t){n&&n(t),e&&e(t)})}else t.push(e)}function setNoOp(t){delete t.op,delete t.create,delete t.del}function transformX(t,i){if(t.del)return setNoOp(i);if(i.del)return new _$error_14(ERROR_CODE.ERR_DOC_WAS_DELETED,"Document was deleted");if(i.create)return new _$error_14(ERROR_CODE.ERR_DOC_ALREADY_CREATED,"Document already created");if(i.op){if(t.create)return new _$error_14(ERROR_CODE.ERR_DOC_ALREADY_CREATED,"Document already created");if(t.type.transformX){var e=t.type.transformX(t.op,i.op);t.op=e[0],i.op=e[1]}else{var n=t.type.transform(t.op,i.op,"left"),s=t.type.transform(i.op,t.op,"right");t.op=n,i.op=s}}}function callEach(t,i){for(var e=!1,n=0;n<t.length;n++){var s=t[n];s&&(s(i),e=!0)}return e}_$doc_8=Doc,_$emitter_13.mixin(Doc),Doc.prototype.destroy=function(t){var i=this;i.whenNothingPending(function(){i.wantSubscribe?i.unsubscribe(function(e){if(e)return t?t(e):i.emit("error",e);i.connection._destroyDoc(i),t&&t()}):(i.connection._destroyDoc(i),t&&t())})},Doc.prototype._setType=function(t){if("string"==typeof t&&(t=_$types_18.map[t]),t)this.type=t;else{if(null!==t){var i=new _$error_14(ERROR_CODE.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+t);return this.emit("error",i)}this.type=t,this.data=void 0}},Doc.prototype.ingestSnapshot=function(t,i){if(!t)return i&&i();if("number"!=typeof t.v){var e=new _$error_14(ERROR_CODE.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return i?i(e):this.emit("error",e)}if(this.type||this.hasWritePending()){if(null==this.version){if(this.hasWritePending())return i&&this.once("no write pending",i);e=new _$error_14(ERROR_CODE.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return i?i(e):this.emit("error",e)}return t.v>this.version?this.fetch(i):i&&i()}if(this.version>t.v)return i&&i();this.version=t.v;var n=void 0===t.type?_$types_18.defaultType:t.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),i&&i()},Doc.prototype.whenNothingPending=function(t){var i=this;process.nextTick(function(){i.hasPending()?i.once("nothing pending",t):t()})},Doc.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},Doc.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},Doc.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},Doc.prototype._emitResponseError=function(t,i){if(i)return i(t),void this._emitNothingPending();this._emitNothingPending(),this.emit("error",t)},Doc.prototype._handleFetch=function(t,i){var e=this.inflightFetch.shift();if(t)return this._emitResponseError(t,e);this.ingestSnapshot(i,e),this._emitNothingPending()},Doc.prototype._handleSubscribe=function(t,i){var e=this.inflightSubscribe.shift();if(t)return this._emitResponseError(t,e);this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(i,e),this._emitNothingPending()},Doc.prototype._handleUnsubscribe=function(t){var i=this.inflightUnsubscribe.shift();if(t)return this._emitResponseError(t,i);i&&i(),this._emitNothingPending()},Doc.prototype._handleOp=function(t,i){if(t)return this.inflightOp?(t.code===ERROR_CODE.ERR_OP_SUBMIT_REJECTED&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&i.src===this.inflightOp.src&&i.seq===this.inflightOp.seq)this._opAcknowledged(i);else if(null==this.version||i.v>this.version)this.fetch();else if(!(i.v<this.version)){if(this.inflightOp)if(n=transformX(this.inflightOp,i))return this._hardRollback(n);for(var e=0;e<this.pendingOps.length;e++){var n;if(n=transformX(this.pendingOps[e],i))return this._hardRollback(n)}this.version++;try{this._otApply(i,!1)}catch(t){return this._hardRollback(t)}}},Doc.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)this.flush(),this._resubscribe();else if(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length){var t=this.inflightUnsubscribe;this.inflightUnsubscribe=[],callEach(t)}},Doc.prototype._resubscribe=function(){var t=this.pendingFetch;if(this.pendingFetch=[],this.wantSubscribe)return t.length?void this.subscribe(function(i){callEach(t,i)}):void this.subscribe();t.length&&this.fetch(function(i){callEach(t,i)})},Doc.prototype.fetch=function(t){if(this.connection.canSend){var i=this.connection.sendFetch(this);pushActionCallback(this.inflightFetch,i,t)}else this.pendingFetch.push(t)},Doc.prototype.subscribe=function(t){if(this.wantSubscribe=!0,this.connection.canSend){var i=this.connection.sendSubscribe(this);pushActionCallback(this.inflightSubscribe,i,t)}else this.pendingFetch.push(t)},Doc.prototype.unsubscribe=function(t){if(this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend){var i=this.connection.sendUnsubscribe(this);pushActionCallback(this.inflightUnsubscribe,i,t)}else t&&process.nextTick(t)},Doc.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},Doc.prototype._otApply=function(t,i){if(t.op){if(!this.type)throw new _$error_14(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(!i&&this.type===_$types_18.defaultType&&t.op.length>1){this.applyStack||(this.applyStack=[]);for(var e=this.applyStack.length,n=0;n<t.op.length;n++){for(var s={op:[t.op[n]]},r=e;r<this.applyStack.length;r++){var h=transformX(this.applyStack[r],s);if(h)return this._hardRollback(h)}this.emit("before op",s.op,i),this.data=this.type.apply(this.data,s.op),this.emit("op",s.op,i)}return void this._popApplyStack(e)}return this.emit("before op",t.op,i),this.data=this.type.apply(this.data,t.op),void this.emit("op",t.op,i)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",i);if(t.del){var o=this.data;return this._setType(null),void this.emit("del",o,i)}},Doc.prototype._sendOp=function(){var t=this.connection.id;if(t){this.inflightOp||(this.inflightOp=this.pendingOps.shift());var i=this.inflightOp;if(!i){var e=new _$error_14(ERROR_CODE.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp");return this.emit("error",e)}i.sentAt=Date.now(),i.retries=null==i.retries?0:i.retries+1,null==i.seq&&(i.seq=this.connection.seq++),this.connection.sendOp(this,i),null==i.src&&(i.src=t)}},Doc.prototype._submit=function(t,i,e){if(i||(i=!0),t.op){if(!this.type){var n=new _$error_14(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return e?e(n):this.emit("error",n)}this.type.normalize&&(t.op=this.type.normalize(t.op))}try{this._pushOp(t,e),this._otApply(t,i)}catch(t){return this._hardRollback(t)}var s=this;process.nextTick(function(){s.flush()})},Doc.prototype._pushOp=function(t,i){if(this.applyStack)this.applyStack.push(t);else{var e=this._tryCompose(t);if(e)return void e.callbacks.push(i)}t.type=this.type,t.callbacks=[i],this.pendingOps.push(t)},Doc.prototype._popApplyStack=function(t){if(t>0)this.applyStack.length=t;else{var i=this.applyStack[0];if(this.applyStack=null,i)if(-1!==(n=this.pendingOps.indexOf(i)))for(var e=this.pendingOps.splice(n),n=0;n<e.length;n++){i=e[n];var s=this._tryCompose(i);s?s.callbacks=s.callbacks.concat(i.callbacks):this.pendingOps.push(i)}}},Doc.prototype._tryCompose=function(t){if(!this.preventCompose){var i=this.pendingOps[this.pendingOps.length-1];if(i&&!i.sentAt)return i.create&&t.op?(i.create.data=this.type.apply(i.create.data,t.op),i):i.op&&t.op&&this.type.compose?(i.op=this.type.compose(i.op,t.op),i):void 0}},Doc.prototype.submitOp=function(t,i,e){"function"==typeof i&&(e=i,i=null);var n={op:t},s=i&&i.source;this._submit(n,s,e)},Doc.prototype.create=function(t,i,e,n){if("function"==typeof i?(n=i,e=null,i=null):"function"==typeof e&&(n=e,e=null),i||(i=_$types_18.defaultType.uri),this.type){var s=new _$error_14(ERROR_CODE.ERR_DOC_ALREADY_CREATED,"Document already exists");return n?n(s):this.emit("error",s)}var r={create:{type:i,data:t}},h=e&&e.source;this._submit(r,h,n)},Doc.prototype.del=function(t,i){if("function"==typeof t&&(i=t,t=null),!this.type){var e=new _$error_14(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");return i?i(e):this.emit("error",e)}var n=t&&t.source;this._submit({del:!0},n,i)},Doc.prototype.pause=function(){this.paused=!0},Doc.prototype.resume=function(){this.paused=!1,this.flush()},Doc.prototype._opAcknowledged=function(t){if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return _$logger_15.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},Doc.prototype._rollback=function(t){var i=this.inflightOp;if(i.op&&i.type.invert){i.op=i.type.invert(i.op);for(var e=0;e<this.pendingOps.length;e++){var n=transformX(this.pendingOps[e],i);if(n)return this._hardRollback(n)}try{this._otApply(i,!1)}catch(t){return this._hardRollback(t)}this._clearInflightOp(t)}else this._hardRollback(t)},Doc.prototype._hardRollback=function(t){var i=[];this.inflightOp&&i.push(this.inflightOp),i=i.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var e=this;this.fetch(function(){for(var n=!!i.length,s=0;s<i.length;s++)n=callEach(i[s].callbacks,t)&&n;if(t&&!n)return e.emit("error",t)})},Doc.prototype._clearInflightOp=function(t){var i=this.inflightOp;this.inflightOp=null;var e=callEach(i.callbacks,t);if(this.flush(),this._emitNothingPending(),t&&!e)return this.emit("error",t)}}).call(this,_$browser_6);var _$query_9={};(function(process){function Query(t,e,s,i,n,r,o){_$emitter_13.EventEmitter.call(this),this.action=t,this.connection=e,this.id=s,this.collection=i,this.query=n,this.results=null,r&&r.results&&(this.results=r.results,delete r.results),this.extra=void 0,this.options=r,this.callback=o,this.ready=!1,this.sent=!1}_$query_9=Query,_$emitter_13.mixin(Query),Query.prototype.hasPending=function(){return!this.ready},Query.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],s=0;s<this.results.length;s++){var i=this.results[s];e.push([i.id,i.version])}t.r=e}this.connection.send(t),this.sent=!0}},Query.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&process.nextTick(t)},Query.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},Query.prototype._handleFetch=function(t,e,s){this.connection._destroyQuery(this),this._handleResponse(t,e,s)},Query.prototype._handleSubscribe=function(t,e,s){this._handleResponse(t,e,s)},Query.prototype._handleResponse=function(t,e,s){var i=this.callback;if(this.callback=null,t)return this._finishResponse(t,i);if(!e)return this._finishResponse(null,i);var n=this,r=1,o=function(t){if(t)return n._finishResponse(t,i);--r||n._finishResponse(null,i)};if(Array.isArray(e))r+=e.length,this.results=this._ingestSnapshots(e,o),this.extra=s;else for(var h in e){r++;var c=e[h];this.connection.get(c.c||this.collection,h).ingestSnapshot(c,o)}o()},Query.prototype._ingestSnapshots=function(t,e){for(var s=[],i=0;i<t.length;i++){var n=t[i],r=this.connection.get(n.c||this.collection,n.d);r.ingestSnapshot(n,e),s.push(r)}return s},Query.prototype._finishResponse=function(t,e){if(this.emit("ready"),this.ready=!0,t)return this.connection._destroyQuery(this),e?e(t):this.emit("error",t);e&&e(null,this.results,this.extra)},Query.prototype._handleError=function(t){this.emit("error",t)},Query.prototype._handleDiff=function(t){for(var e=0;e<t.length;e++){"insert"===(s=t[e]).type&&(s.values=this._ingestSnapshots(s.values))}for(e=0;e<t.length;e++){var s;switch((s=t[e]).type){case"insert":var i=s.values;Array.prototype.splice.apply(this.results,[s.index,0].concat(i)),this.emit("insert",i,s.index);break;case"remove":var n=s.howMany||1,r=this.results.splice(s.index,n);this.emit("remove",r,s.index);break;case"move":n=s.howMany||1;var o=this.results.splice(s.from,n);Array.prototype.splice.apply(this.results,[s.to,0].concat(o)),this.emit("move",o,s.from,s.to)}}this.emit("changed",this.results)},Query.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)}}).call(this,_$browser_6);function Snapshot(t,s,h,i,o){this.id=t,this.v=s,this.type=h,this.data=i,this.m=o}var _$Snapshot_17=Snapshot;var _$snapshotRequest_10={};function SnapshotRequest(t,e,n,s,i){if(_$emitter_13.EventEmitter.call(this),"function"!=typeof i)throw new Error("Callback is required for SnapshotRequest");this.requestId=e,this.connection=t,this.id=s,this.collection=n,this.callback=i,this.sent=!1}_$snapshotRequest_10=SnapshotRequest,_$emitter_13.mixin(SnapshotRequest),SnapshotRequest.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},SnapshotRequest.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},SnapshotRequest.prototype._handleResponse=function(t,e){if(this.emit("ready"),t)return this.callback(t);var n=e.meta?e.meta:null,s=new _$Snapshot_17(this.id,e.v,e.type,e.data,n);this.callback(null,s)};var _$util_19={};function doNothing(){}_$util_19.doNothing=doNothing,_$util_19.hasKeys=function(n){for(var r in n)return!0;return!1},_$util_19.isInteger=Number.isInteger||function(n){return"number"==typeof n&&isFinite(n)&&Math.floor(n)===n},_$util_19.isValidVersion=function(n){return null===n||_$util_19.isInteger(n)&&n>=0},_$util_19.isValidTimestamp=function(n){return _$util_19.isValidVersion(n)};var _$snapshotVersionRequest_12={};function SnapshotVersionRequest(e,t,s,o,i,r){if(_$snapshotRequest_10.call(this,e,t,s,o,r),!_$util_19.isValidVersion(i))throw new Error("Snapshot version must be a positive integer or null");this.version=i}_$snapshotVersionRequest_12=SnapshotVersionRequest,SnapshotVersionRequest.prototype=Object.create(_$snapshotRequest_10.prototype),SnapshotVersionRequest.prototype._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}};var _$snapshotTimestampRequest_11={};function SnapshotTimestampRequest(t,e,s,i,o,p){if(_$snapshotRequest_10.call(this,t,e,s,i,p),!_$util_19.isValidTimestamp(o))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=o}_$snapshotTimestampRequest_11=SnapshotTimestampRequest,SnapshotTimestampRequest.prototype=Object.create(_$snapshotRequest_10.prototype),SnapshotTimestampRequest.prototype._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}};var _$connection_7={};(function(process){var ERROR_CODE=_$error_14.CODES;function connectionState(t){return 0===t.readyState||1===t.readyState?"connecting":"disconnected"}function Connection(t){_$emitter_13.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._snapshotRequests={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.state=connectionState(t),this.bindToSocket(t)}function hasPending(t){return t.hasPending()}function hasWritePending(t){return t.hasWritePending()}_$connection_7=Connection,_$emitter_13.mixin(Connection),Connection.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=t;var e=connectionState(t);this._setState(e),this.canSend=!1;var n=this;t.onmessage=function(t){try{var e="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){return void _$logger_15.warn("Failed to parse message",t)}n.debug&&_$logger_15.info("RECV",JSON.stringify(e));var i={data:e};if(n.emit("receive",i),i.data)try{n.handleMessage(i.data)}catch(t){process.nextTick(function(){n.emit("error",t)})}},t.onopen=function(){n._setState("connecting")},t.onerror=function(t){n.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?n._setState("closed",t):"stopped"===t||"Stopped by server"===t?n._setState("stopped",t):n._setState("disconnected",t)}},Connection.prototype.handleMessage=function(t){var e=null;switch(t.error&&((e=new Error(t.error.message)).code=t.error.code,e.data=t,delete t.error),t.a){case"init":return 1!==t.protocol?(e=new _$error_14(ERROR_CODE.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+t.protocol),this.emit("error",e)):_$types_18.map[t.type]!==_$types_18.defaultType?(e=new _$error_14(ERROR_CODE.ERR_DEFAULT_TYPE_MISMATCH,t.type+" does not match the server default type"),this.emit("error",e)):"string"!=typeof t.id?(e=new _$error_14(ERROR_CODE.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string"),this.emit("error",e)):(this.id=t.id,void this._setState("connected"));case"qf":return void((n=this.queries[t.id])&&n._handleFetch(e,t.data,t.extra));case"qs":return void((n=this.queries[t.id])&&n._handleSubscribe(e,t.data,t.extra));case"qu":return;case"q":var n;if(!(n=this.queries[t.id]))return;return e?n._handleError(e):(t.diff&&n._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&n._handleExtra(t.extra)));case"bf":return this._handleBulkMessage(t,"_handleFetch");case"bs":return this._handleBulkMessage(t,"_handleSubscribe");case"bu":return this._handleBulkMessage(t,"_handleUnsubscribe");case"nf":case"nt":return this._handleSnapshotFetch(e,t);case"f":return void((i=this.getExisting(t.c,t.d))&&i._handleFetch(e,t.data));case"s":return void((i=this.getExisting(t.c,t.d))&&i._handleSubscribe(e,t.data));case"u":return void((i=this.getExisting(t.c,t.d))&&i._handleUnsubscribe(e));case"op":var i;return void((i=this.getExisting(t.c,t.d))&&i._handleOp(e,t));default:_$logger_15.warn("Ignoring unrecognized message",t)}},Connection.prototype._handleBulkMessage=function(t,e){if(t.data)for(var n in t.data){(o=this.getExisting(t.c,n))&&o[e](t.error,t.data[n])}else if(Array.isArray(t.b))for(var i=0;i<t.b.length;i++){n=t.b[i];(o=this.getExisting(t.c,n))&&o[e](t.error)}else if(t.b)for(var n in t.b){var o;(o=this.getExisting(t.c,n))&&o[e](t.error)}else _$logger_15.error("Invalid bulk message",t)},Connection.prototype._reset=function(){this.seq=1,this.id=null,this.agent=null},Connection.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state){var n=new _$error_14(ERROR_CODE.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+t);return this.emit("error",n)}for(var i in this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk(),this.queries){this.queries[i]._onConnectionStateChanged()}for(var o in this.collections){var s=this.collections[o];for(var i in s)s[i]._onConnectionStateChanged()}for(var i in this._snapshotRequests){this._snapshotRequests[i]._onConnectionStateChanged()}this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},Connection.prototype.startBulk=function(){this.bulk||(this.bulk={})},Connection.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},Connection.prototype._sendBulk=function(t,e,n){if(n){var i,o=[],s={},r=0;for(var c in n){var a=n[c];null==a?o.push(c):(s[c]=a,i=c,r++)}if(1===o.length){c=o[0];this.send({a:t,c:e,d:c})}else o.length&&this.send({a:"b"+t,c:e,b:o});if(1===r){var h=s[i];this.send({a:t,c:e,d:i,v:h})}else r&&this.send({a:"b"+t,c:e,b:s})}},Connection.prototype._sendAction=function(t,e,n){if(this._addDoc(e),this.bulk){var i=this.bulk[e.collection]||(this.bulk[e.collection]={}),o=i[t]||(i[t]={}),s=o.hasOwnProperty(e.id);return o[e.id]=n,s}var r={a:t,c:e.collection,d:e.id,v:n};this.send(r)},Connection.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},Connection.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},Connection.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},Connection.prototype.sendOp=function(t,e){this._addDoc(t);var n={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq};e.op&&(n.op=e.op),e.create&&(n.create=e.create),e.del&&(n.del=e.del),this.send(n)},Connection.prototype.send=function(t){this.debug&&_$logger_15.info("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},Connection.prototype.close=function(){this.socket.close()},Connection.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},Connection.prototype.get=function(t,e){var n=this.collections[t]||(this.collections[t]={}),i=n[e];return i||(i=n[e]=new _$doc_8(this,t,e),this.emit("doc",i)),i},Connection.prototype._destroyDoc=function(t){var e=this.collections[t.collection];e&&(delete e[t.id],_$util_19.hasKeys(e)||delete this.collections[t.collection])},Connection.prototype._addDoc=function(t){var e=this.collections[t.collection];e||(e=this.collections[t.collection]={}),e[t.id]!==t&&(e[t.id]=t)},Connection.prototype._createQuery=function(t,e,n,i,o){var s=this.nextQueryId++,r=new _$query_9(t,this,s,e,n,i,o);return this.queries[s]=r,r.send(),r},Connection.prototype._destroyQuery=function(t){delete this.queries[t.id]},Connection.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("qf",t,e,n,i)},Connection.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("qs",t,e,n,i)},Connection.prototype.hasPending=function(){return!!(this._firstDoc(hasPending)||this._firstQuery(hasPending)||this._firstSnapshotRequest())},Connection.prototype.hasWritePending=function(){return!!this._firstDoc(hasWritePending)},Connection.prototype.whenNothingPending=function(t){var e=this._firstDoc(hasPending);if(e)e.once("nothing pending",this._nothingPendingRetry(t));else{var n=this._firstQuery(hasPending);if(n)n.once("ready",this._nothingPendingRetry(t));else{var i=this._firstSnapshotRequest();i?i.once("ready",this._nothingPendingRetry(t)):process.nextTick(t)}}},Connection.prototype._nothingPendingRetry=function(t){var e=this;return function(){process.nextTick(function(){e.whenNothingPending(t)})}},Connection.prototype._firstDoc=function(t){for(var e in this.collections){var n=this.collections[e];for(var i in n){var o=n[i];if(t(o))return o}}},Connection.prototype._firstQuery=function(t){for(var e in this.queries){var n=this.queries[e];if(t(n))return n}},Connection.prototype._firstSnapshotRequest=function(){for(var t in this._snapshotRequests)return this._snapshotRequests[t]},Connection.prototype.fetchSnapshot=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var o=this.nextSnapshotRequestId++,s=new _$snapshotVersionRequest_12(this,o,t,e,n,i);this._snapshotRequests[s.requestId]=s,s.send()},Connection.prototype.fetchSnapshotByTimestamp=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var o=this.nextSnapshotRequestId++,s=new _$snapshotTimestampRequest_11(this,o,t,e,n,i);this._snapshotRequests[s.requestId]=s,s.send()},Connection.prototype._handleSnapshotFetch=function(t,e){var n=this._snapshotRequests[e.id];n&&(delete this._snapshotRequests[e.id],n._handleResponse(t,e))}}).call(this,_$browser_6);var _$client_sharedb={};_$client_sharedb.Connection=_$connection_7,_$client_sharedb.Doc=_$doc_8,_$client_sharedb.Error=_$error_14,_$client_sharedb.Query=_$query_9,_$client_sharedb.types=_$types_18,_$client_sharedb.logger=_$logger_15;exposedRequire.m["sharedb"]=_$client_sharedb;return exposedRequire}(typeof require==="function"?require:void 0);
(function(){var sharedb,main;sharedb=require("sharedb");main=function(opt){var p;opt==null&&(opt={});import$(this,{scheme:(opt.url||(opt.url={})).scheme||window.location.protocol.replace(":",""),domain:opt.url.domain||window.location.host,path:p=opt.url.path||"/ws"});this.path=p[0]==="/"?p:"/"+p;this.scheme=this.scheme==="http"?"ws":"wss";this.evtHandler={};this.reconnectInfo={retry:0,pending:[]};this.reconnect();return this};main.prototype=import$(Object.create(Object.prototype),{getSnapshot:function(arg$){var id,version,collection,this$=this;id=arg$.id,version=arg$.version,collection=arg$.collection;return new Promise(function(res,rej){return this$.connection.fetchSnapshot(collection!=null?collection:"doc",id,version!=null?version:null,function(e,s){if(e){return rej(e)}else{return res(s)}})})},ready:function(){var this$=this;return new Promise(function(res,rej){if(this$.connected){return res()}if(!this$.reconnectInfo.handler){return this$.reconnect()}return this$.reconnectInfo.pending.push({res:res,rej:rej})})},get:function(arg$){var id,watch,create,collection,this$=this;id=arg$.id,watch=arg$.watch,create=arg$.create,collection=arg$.collection;return(!this.connection?this.reconnect():Promise.resolve()).then(function(){return new Promise(function(res,rej){var doc;doc=this$.connection.get(collection!=null?collection:"doc",id);return doc.fetch(function(e){if(e){return rej(e)}doc.subscribe(function(ops,source){return res(doc)});doc.on("error",function(err){return this$.fire("error",{doc:doc,err:err})});if(watch!=null){doc.on("op",function(ops,source){return watch(ops,source)})}if(!doc.type){return doc.create((create?create():null)||{})}})})})},on:function(n,cb){var ref$;return((ref$=this.evtHandler)[n]||(ref$[n]=[])).push(cb)},fire:function(n){var v,res$,i$,to$,ref$,len$,cb,results$=[];res$=[];for(i$=1,to$=arguments.length;i$<to$;++i$){res$.push(arguments[i$])}v=res$;for(i$=0,len$=(ref$=this.evtHandler[n]||[]).length;i$<len$;++i$){cb=ref$[i$];results$.push(cb.apply(this,v))}return results$},disconnect:function(){if(!this.socket){return}this.socket.close();this.socket=null;this.connected=false;return this.socket=null},reconnect:function(){var this$=this;return new Promise(function(res,rej){var delay;if(this$.socket){return res()}delay=this$.reconnectInfo.retry++;delay=Math.round(Math.pow(delay,1.4)*500);clearTimeout(this$.reconnectInfo.handler);console.log("try reconnecting ("+this$.reconnectInfo.retry+") after "+delay+"ms ...");return this$.reconnectInfo.handler=setTimeout(function(){this$.reconnectInfo.handler=null;this$.socket=new WebSocket(this$.scheme+"://"+this$.domain+this$.path);this$.connection=new sharedb.Connection(this$.socket);this$.socket.addEventListener("close",function(){this$.socket=null;this$.connected=false;return this$.fire("close")});return this$.socket.addEventListener("open",function(){var ref$;this$.reconnectInfo.retry=0;((ref$=this$.reconnectInfo).pending||(ref$.pending=[])).splice(0).map(function(it){return it.res()});this$.connected=true;return res()})},delay)})}});if(typeof module!="undefined"&&module!==null){module.exports=main}if(typeof window!="undefined"&&window!==null){window.sharedbWrapper=main}function import$(obj,src){var own={}.hasOwnProperty;for(var key in src)if(own.call(src,key))obj[key]=src[key];return obj}}).call(this);
